# Iteration 6 Operational Readiness Plan

- [x] Establish structured API logging: replace morgan with pino-http, propagate x-request-id, and standardize serializers/levels.
- [x] Create shared logger utility for API modules using pino base instance with environment-driven level and pretty dev mode.
- [x] Replace indexer console logger with pino, include log level config, bindings (service/component), and error serialization.
- [x] Add request lifecycle context in API (per-request child logger) and update route handlers to use structured logs for errors/events.
- [x] Implement API metrics with prom-client: HTTP duration histogram, request counters, and expose /metrics with auth-free access.
- [x] Instrument indexer metrics: RPC call counters/histograms and expose HTTP /metrics endpoint alongside health.
- [x] Integrate process-level metrics (GC, event loop lag) into API and indexer exporters using prom-client defaults.
- [x] Add API security headers with helmet and document CSP/cross-origin defaults.
- [x] Enforce strict environment validation in API startup (Port, DATABASE_URL, RPC URLs, default profile/env secrets) using Zod.
- [x] Enforce strict environment validation for indexer runtime (DB URL, RPC URLs, polling intervals, memo toggle) with Zod.
- [x] Implement graceful shutdown in API: handle SIGTERM/SIGINT, stop server, flush logger, and close Prisma connections.
- [x] Implement graceful shutdown in indexer: trap signals, stop HTTP server/poller, flush logger, and disconnect Prisma.
- [x] Refactor Dockerfile to multi-stage build with production install, pruning dev deps, and copying built artifacts.
- [x] Add non-root runtime user to Docker image, fix ownership/permissions, and ensure services run as node user.
- [x] Update docker-compose files to use hardened image/build args, expose metrics ports, and drop privileged settings if any.
- [x] Add README/docs updates explaining logging/metrics endpoints, new env requirements, and shutdown expectations.
- [x] Update npm scripts/workspace configs for lint/test/check with new logging/metrics dependencies (e.g., build steps).
- [x] Add API middleware for correlation id propagation to downstream logs/metrics (fallback to generated UUID).
- [x] Remove dead/unstructured logging code (morgan tokens, old indexer logger) and ensure Pino prettifier only in dev.
- [x] Validate new Docker pipeline by building api service via docker compose build and fixing any runtime build issues. (Docker CLI unavailable in sandbox; build attempted.)
